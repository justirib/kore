<!DOCTYPE html>
<html>
<head>
    <title>kore (x64)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, sans-serif; touch-action: none; -webkit-user-select: none; user-select: none; }
        #win32-menubar {
            position: absolute; top: 0; left: 0; right: 0; height: 30px;
            background: #ffffff; display: flex; align-items: center;
            padding: 0 15px; border-bottom: 1px solid #d0d0d0;
            z-index: 2000; color: #000; font-size: 11px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* Hidden by default, styled for Win32 Mobile */
        #mobile-controls { position: absolute; bottom: 0; left: 0; right: 0; top: 30px; pointer-events: none; z-index: 1000; display: none; }
        #stick-base { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: #fff; border: 1px solid #707070; box-shadow: 1px 1px #000; pointer-events: auto; }
        #stick-knob { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #f0f0f0; border: 1px solid #707070; box-shadow: inset -1px -1px #a0a0a0; }
        #jump-btn { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: #fff; border: 1px solid #707070; box-shadow: 1px 1px #000; pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #000; }
    </style>
</head>
<body>

<div id="win32-menubar"><span id="title-string"></span></div>
<div id="mobile-controls">
    <div id="stick-base"><div id="stick-knob"></div></div>
    <div id="jump-btn">JUMP</div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    document.getElementById('title-string').textContent = `kore (x64) - ${navigator.userAgent}`;

    const scene = new THREE.Scene();
    const skyCanvas = document.createElement('canvas');
    skyCanvas.width = 2; skyCanvas.height = 512;
    const sCtx = skyCanvas.getContext('2d');
    const grad = sCtx.createLinearGradient(0, 0, 0, 512);
    grad.addColorStop(0, '#4584b4'); grad.addColorStop(0.5, '#c8ced8'); grad.addColorStop(1, '#a1a8b3');
    sCtx.fillStyle = grad; sCtx.fillRect(0, 0, 2, 512);
    scene.background = new THREE.CanvasTexture(skyCanvas);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // --- CHECKERED BASEPLATE ---
    const ctx = document.createElement('canvas').getContext('2d');
    ctx.canvas.width = 128; ctx.canvas.height = 128;
    ctx.fillStyle = '#888888'; ctx.fillRect(0,0,64,64); ctx.fillRect(64,64,64,64);
    ctx.fillStyle = '#444444'; ctx.fillRect(64,0,64,64); ctx.fillRect(0,64,64,64);
    const checkerTex = new THREE.CanvasTexture(ctx.canvas);
    checkerTex.wrapS = checkerTex.wrapT = THREE.RepeatWrapping;
    checkerTex.magFilter = THREE.NearestFilter;
    checkerTex.repeat.set(20, 20);

    const baseplate = new THREE.Mesh(new THREE.BoxGeometry(40, 0.5, 40), new THREE.MeshStandardMaterial({ map: checkerTex }));
    scene.add(baseplate, new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.DirectionalLight(0xffffff, 1.2); sun.position.set(10, 20, 10); scene.add(sun);

    // --- CHARACTER ---
    const charGroup = new THREE.Group();
    const charGeo = new THREE.BoxGeometry(1, 1, 1);
    const charMesh = new THREE.Mesh(charGeo, new THREE.MeshStandardMaterial({ color: 0xffffff }));
    const outline = new THREE.Mesh(charGeo, new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.BackSide }));
    outline.scale.set(1.15, 1.15, 1.15);
    charGroup.add(charMesh, outline);
    charGroup.position.set(0, 2, 0);
    scene.add(charGroup);

    // --- STATE ---
    let camAngle = 0, camHeight = 5, camDist = 10, velocityY = 0, isPaused = false;
    const keys = {}, joyPos = { x: 0, y: 0 };
    let touchData = { isTouching: false, lastX: 0, lastY: 0, lastDist: 0 };
    const MOVE_SPEED = 0.08; // Lowered speed

    window.addEventListener('blur', () => isPaused = true);
    window.addEventListener('focus', () => isPaused = false);

    // --- INPUT HANDLERS ---
    const mobileUI = document.getElementById('mobile-controls');
    
    // Seamless mode detection: Show controls only on touch
    window.addEventListener('touchstart', (e) => {
        mobileUI.style.display = 'block';
        if(e.touches.length === 1) {
            touchData.lastX = e.touches[0].clientX;
            touchData.lastY = e.touches[0].clientY;
            touchData.isTouching = true;
        } else if(e.touches.length === 2) {
            touchData.lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        if(isPaused) return;
        if(e.touches.length === 1 && touchData.isTouching) {
            if(e.target.closest('#stick-base') || e.target.closest('#jump-btn')) return;
            camAngle += (e.touches[0].clientX - touchData.lastX) * 0.01;
            camHeight = Math.max(1, Math.min(15, camHeight - (e.touches[0].clientY - touchData.lastY) * 0.1));
            touchData.lastX = e.touches[0].clientX;
            touchData.lastY = e.touches[0].clientY;
        } else if(e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            camDist = Math.max(2, Math.min(30, camDist - (dist - touchData.lastDist) * 0.1));
            touchData.lastDist = dist;
        }
    }, { passive: false });

    // Thumbstick & Jump logic
    document.getElementById('stick-base').addEventListener('touchmove', (e) => {
        const b = e.currentTarget.getBoundingClientRect();
        const dx = e.touches[0].clientX - (b.left + 50), dy = e.touches[0].clientY - (b.top + 50);
        const d = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        const a = Math.atan2(dy, dx);
        joyPos.x = (Math.cos(a)*d)/40; joyPos.y = (Math.sin(a)*d)/40;
        document.getElementById('stick-knob').style.transform = `translate(${joyPos.x*30}px,${joyPos.y*30}px)`;
    });
    document.getElementById('stick-base').addEventListener('touchend', () => { joyPos.x = joyPos.y = 0; document.getElementById('stick-knob').style.transform = 'translate(0,0)'; });
    document.getElementById('jump-btn').addEventListener('touchstart', () => { if(!isPaused) velocityY = 0.3; });

    window.addEventListener('keydown', (e) => { 
        keys[e.code] = true; 
        if(e.code === 'Space' && !isPaused) velocityY = 0.3;
    });
    window.addEventListener('keyup', (e) => keys[e.code] = false);

    function animate() {
        requestAnimationFrame(animate);
        if(isPaused) return;

        // Camera Rotation (Keyboard)
        if(keys['ArrowLeft']) camAngle -= 0.03;
        if(keys['ArrowRight']) camAngle += 0.03;
        if(keys['ArrowUp']) camHeight = Math.min(15, camHeight + 0.1);
        if(keys['ArrowDown']) camHeight = Math.max(1, camHeight - 0.1);
        if(keys['KeyI']) camDist = Math.max(2, camDist - 0.2);
        if(keys['KeyO']) camDist = Math.min(30, camDist + 0.2);

        const fwd = new THREE.Vector3(Math.sin(camAngle), 0, Math.cos(camAngle));
        const rit = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), fwd);
        
        let mx = joyPos.x + (keys['KeyD']?1:0) - (keys['KeyA']?1:0);
        let mz = joyPos.y + (keys['KeyS']?1:0) - (keys['KeyW']?1:0);
        
        charGroup.position.addScaledVector(fwd, -mz * MOVE_SPEED);
        charGroup.position.addScaledVector(rit, mx * MOVE_SPEED);

        velocityY -= 0.015;
        charGroup.position.y += velocityY;
        if(charGroup.position.y < 0.75) { charGroup.position.y = 0.75; velocityY = 0; }

        camera.position.set(charGroup.position.x + Math.sin(camAngle)*camDist, charGroup.position.y + camHeight, charGroup.position.z + Math.cos(camAngle)*camDist);
        camera.lookAt(charGroup.position);
        renderer.render(scene, camera);
    }
    animate();
    window.addEventListener('resize', () => { camera.aspect = window.innerWidth/(window.innerHeight-30); camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
</script>
</body>
</html>
